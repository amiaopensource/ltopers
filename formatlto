#!/bin/bash
# formatlto
# formats an LTO tape for LTFS
version="0.2"

SCRIPTDIR=$(dirname "${0}")

_usage(){
    echo
    echo "$(basename ${0}) ${version}"
    echo "format lto tapes with ltfs"
    echo "Dependencies: ${dependencies[@]}"
    echo "Usage: $(basename $0) [ -f ]"
    echo "  -f force formating"
    echo "  -c use compression"
    echo "  -h ( display this help )"
    echo
    exit
}

. "${SCRIPTDIR}/mmfunctions" || { echo "Missing '${SCRIPTDIR}/mmfunctions'. Exiting." ; exit 1 ;};
dependencies=(mkltfs)


unset MIDDLE_OPTIONS
while getopts ":fch" opt ; do
   case "${opt}" in
       f) MIDDLE_OPTIONS+=(-f) ;;
       c) COMPRESS=1 ;;
       h) _usage ;;
       *) echo "bad option -$OPTARG" ; _usage ;;
       :) echo "Option -$OPTARG requires an argument" ; exit 1 ;;
   esac
done

if [ ! "${COMPRESS}" = "1" ] ; then
    MIDDLE_OPTIONS+=(-c)
else
    echo "${GREEN}Will use compression.${NC}"
fi

if [ ! "${LTO_ARRAY}" ] ; then
    if [[ $(uname -s) == "Darwin" ]] ; then
        LTO_ARRAY=($(system_profiler SPSASDataType | grep "SCSI Target Identifier" | cut -d : -f2 | sort | xargs)) # try to figure out how many lto decks are attached
    else
        LTO_ARRAY=(0) # to do: itemize when there are multiple lto drives in Linux
    fi
fi

RED="$(tput setaf 1)"   # Red      - For Warnings
GREEN="$(tput setaf 2)" # Green    - For Declarations
BLUE="$(tput setaf 4)"  # Blue     - For Questions
NC="$(tput sgr0)"       # No Color

if [[ "${#LTO_ARRAY[@]}" -gt 1 ]] ; then
   PS3="${BLUE}Which LTO deck?${NC} "
   eval set "${LTO_ARRAY[@]}"
   select DECK in "$@"
   do
       break
   done
   if [ ! "${DECK}" ] ; then
       echo "${RED}ERROR: You selected an invalid deck.${NC}"
       exit 1
   fi
else
   DECK=0
fi

printf "${BLUE}Enter the 6 character tape identifier:${NC} "
read TAPE_ID
if [[ ! $(echo "${TAPE_ID}" | grep -E "^[A-Z0-9]{6}$") ]] ; then
   echo "${RED}ERROR: The tape id must contain exactly 6 capital letters and/or numbers.${NC}"
   exit 1
fi
if [[ $(which ltfs_ldun) ]] ; then
    ltfs_ldun load "${DECK}"
fi
mkltfs ${MIDDLE_OPTIONS[@]} --device=${DECK} --tape-serial="${TAPE_ID}" --volume-name="${TAPE_ID}"
if [[ $(which ltfs_ldun) ]] ; then
    ltfs_ldun unload "${DECK}"
fi
